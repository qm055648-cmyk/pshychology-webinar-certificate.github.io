<script>
async function verify() {
    const idInput = document.getElementById("studentId").value.trim().toLowerCase();
    const msg = document.getElementById("msg");
    const cert = document.getElementById("certificate");

    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ27SgNp1eufIFm41V_E8lXFh6_Nffz2-YLdNM2hOBmEg6Rd9SpOlyYvUUJzYNjh1k1Y5ICWSvKxy3E/pub?output=csv";

    if (!idInput) {
        msg.innerText = "‚ö†Ô∏è Please enter your Student ID";
        msg.style.color = "orange";
        cert.style.display = "none";
        return;
    }

    msg.innerText = "üîç Verifying certificate...";
    msg.style.color = "blue";
    cert.style.display = "none";

    try {
        const res = await fetch(sheetURL + "&cache=" + Math.random());
        const csv = await res.text();

        const rows = csv.split(/\r?\n/);
        let recordFound = false;

        for (let i = 1; i < rows.length; i++) {
            if (!rows[i]) continue;

            // Proper CSV parsing (comma safe)
            const cols = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
            if (!cols || cols.length < 4) continue;

            const sheetId = cols[0].replace(/"/g, "").trim().toLowerCase();

            if (sheetId === idInput) {
                document.getElementById("name").innerText =
                    cols[1].replace(/"/g, "").trim();

                document.getElementById("webinar_title").innerText =
                    cols[2].replace(/"/g, "").trim();

                document.getElementById("certDate").innerText =
                    cols[3].replace(/"/g, "").trim();

                recordFound = true;
                break;
            }
        }

        if (recordFound) {
            msg.innerText = "‚úÖ Certificate Verified Successfully";
            msg.style.color = "green";
            cert.style.display = "block";
        } else {
            msg.innerText = "‚ùå Invalid ID or Record Not Found";
            msg.style.color = "red";
        }

    } catch (error) {
        msg.innerText = "‚ö†Ô∏è Server error. Please try again later.";
        msg.style.color = "orange";
        console.error(error);
    }
}
</script>
